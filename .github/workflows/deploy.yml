name: Deploy to VM (self-hosted)

on:
  push:
    branches: [ "main" ]

jobs:
  deploy:
    runs-on: self-hosted

    steps:
      - name: Debug runner environment
        run: |
          set -euxo pipefail
          echo "=== whoami / hostname / pwd ==="
          whoami
          hostname
          pwd
          echo "=== date ==="
          date
          echo "=== IPs ==="
          ip -br a || true
          echo "=== check paths ==="
          ls -la /var/www/myapp || true
          ls -la /var/www/myapp/public || true
          ls -la /var/www/myapp/hello_phph || true
          ls -la /var/www/myapp/hello_phph/.git || true

      - name: Deploy (sync repo)
        run: |
          set -euxo pipefail

          REPO_DIR="/var/www/myapp/hello_phph"
          BRANCH="main"

          if [ ! -d "$REPO_DIR/.git" ]; then
            echo "ERROR: $REPO_DIR is not a git repo (.git missing)."
            echo "Fix on VM: cd /var/www/myapp && git clone https://github.com/Screameerrr/hello_phph.git hello_phph"
            exit 1
          fi

          cd "$REPO_DIR"

          echo "=== before ==="
          git rev-parse --short HEAD || true
          git status --porcelain || true

          git fetch origin "$BRANCH"
          git checkout "$BRANCH"
          git reset --hard "origin/$BRANCH"

          echo "=== after ==="
          git rev-parse --short HEAD
          git status --porcelain

      - name: Quick HTTP check (local)
        run: |
          set -euxo pipefail
          curl -I http://127.0.0.1/ | head -n 20

