name: Deploy on VM (self-hosted)

on:
  push:
    branches: [ "main" ]

jobs:
  deploy:
    runs-on: self-hosted

    steps:
      - name: Debug runner
        run: |
          whoami
          hostname
          echo "Runner OK"

      - name: Deploy (git sync)
        run: |
          set -e

          REPO_DIR="/var/www/myapp/hello_phph"
          BRANCH="main"

          if [ ! -d "$REPO_DIR/.git" ]; then
            echo "ERROR: $REPO_DIR is not a git repo"
            echo "If your repo is elsewhere, update REPO_DIR."
            exit 1
          fi

          cd "$REPO_DIR"
          git fetch origin "$BRANCH"
          git checkout "$BRANCH"
          git reset --hard "origin/$BRANCH"

          echo "Deploy OK: $(git rev-parse --short HEAD)"
